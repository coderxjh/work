<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jcxx.saas.modules.sys.dao.SysUserDao">
    <!-- 查询用户的所有权限 -->
    <select id="queryAllPerms" resultType="string">
        select m.perms
        from sys_user_role ur
                 LEFT JOIN sys_role_menu rm on ur.role_id = rm.role_id
                 LEFT JOIN sys_menu m on rm.menu_id = m.menu_id
        where ur.user_id = #{userId}
    </select>

    <!-- 查询用户的所有菜单ID -->
    <select id="queryAllMenuId" resultType="long">
        select distinct rm.menu_id
        from sys_user_role ur
                 LEFT JOIN sys_role_menu rm on ur.role_id = rm.role_id
        where ur.user_id = #{userId}
    </select>

    <!-- 通过token查询部门id -->
    <select id="queryDeptByToken" resultType="java.lang.Long">
        select dept_id
        from sys_user su
                 join sys_user_token sut on su.user_id = sut.user_id
        where sut.token = #{token}
    </select>

    <!-- 通过token查询角色id -->
    <select id="queryRolesByToken" resultType="java.lang.Long">
        select role_id
        from sys_user_role sur
                 join sys_user su on sur.user_id = su.user_id
                 join sys_user_token sut on su.user_id = sut.user_id
        where sut.token = #{token}
        order by role_id desc;
    </select>

    <!--    按条件查询部门下面所有的用户信息-->
    <select id="selectByDeptIds" resultType="com.jcxx.saas.modules.sys.entity.SysUserEntity">
        select *
        from sys_user where dept_id in
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        <if test="status!=null">
            and status like concat('%',#{status},'%')
        </if>
        <if test="nameAndPhone!=null and !isPhone">
            <bind name="pattern" value="'%'+nameAndPhone+'%'"/>
            and sys_user.name like #{pattern}
        </if>
        <if test="nameAndPhone!=null and isPhone">
            <bind name="pattern" value="'%'+nameAndPhone+'%'"/>
            and sys_user.mobile like #{pattern}
        </if>
    </select>
</mapper>